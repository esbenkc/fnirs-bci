---
title: "Figures for the thesis 'Lights in the Brain'"
author: "Esben Kran"
date: "4th of January"
---

```{r}
pacman::p_load(tidyverse, R.matlab, showtext, viridis, purrr, ggrepel, png, grid)
font_add_google("Inter", "Inter")
output_dir = "../media/figures/"
```


## HbO and HbR absorption spectra
```{r}
p <- readMat("../data/extinction_coef.mat")[1]$extinct.coef %>% 
  as_tibble %>% 
  select("lambda" = V1, HbO = V2, HbR = V3) %>% 
  pivot_longer(cols=c("HbO", "HbR"), 
               names_to="Haemoglobin", 
               values_to="Extinction coefficient") %>%
  filter(lambda > 675 & lambda < 975) %>% 
  ggplot() +
  aes(x = lambda, y = `Extinction coefficient`, color = Haemoglobin) +
  geom_line() +
  coord_cartesian(expand=F) +
  theme_classic() +
  labs(x = "Î»") +
  geom_vline(xintercept=850, linetype="dashed",
             color=viridis(2, end=0.7)[1]) +
  geom_vline(xintercept=760, linetype="dashed",
             color=viridis(2, end=0.7)[2]) +
  annotate("text", x = 845, y = 2000, hjust=1,
           label="850 HbO", color=viridis(2, end=0.7)[1]) +
  annotate("text", x = 755, y = 2000, hjust=1, 
           label="760 HbR", color=viridis(2, end=0.7)[2]) +
  scale_color_viridis(end=0.7, discrete=T) +
  theme(legend.position = c(0.8,0.7),
        text = element_text(size=10, family="Inter"),
        panel.grid = element_blank(),
        legend.key.height = unit(0.45, "cm"))

ggsave(paste0(output_dir, "absorption-spectrum.png"), p, units="cm", width=15, height=7.5)
```

## Probe positions
```{r fig.width=5, fig.height=5}
mat <- readMat("../data/probe_positions.mat")[1]$probeInfo[[2]]

source_pos = mat[5] %>% 
  as.data.frame %>% 
  select(x=X1, y=X2) %>% 
  mutate(
    index=row_number(),
    type="Source"
  ) %>% 
  inner_join(
    mat[8] %>% 
      as_tibble(.name_repair="universal") %>% 
      map(unlist) %>% 
      as_tibble(.name_repair="universal") %>% 
      select(name=`...1`) %>%
      mutate(index=row_number())
  )

detector_pos = mat[10] %>% 
  as.data.frame %>% 
  select(x=X1, y=X2) %>% 
  mutate(
    index=row_number(),
    type="Detector"
  ) %>% 
  inner_join(
    mat[12] %>% 
      as_tibble(.name_repair="universal") %>% 
      map(unlist) %>% 
      as_tibble(.name_repair="universal") %>% 
      select(name=`...1`) %>%
      mutate(index=row_number())
  )


p <- rbind(detector_pos, source_pos) %>%
  ggplot() +
  aes(x, y, color = type, label = name) +
  annotation_custom(
    rasterGrob(readPNG("../media/10-20_bg.png"), interpolate=T),
    xmin = -0.85, xmax = 0.85, ymin=-0.85) +
  # geom_text_repel(size=2) +
  geom_point(size=1.5, alpha=0.9) +
  annotate("text", size=3, label="Circle indicates the\n'equator' of the head", x = -1.4, y = 1.2, hjust=0, vjust=1, lineheight=1) +
  theme_classic() +
  scale_color_viridis(end=0.7, discrete=T) +
  theme(legend.position = c(0.15,0.8),
        legend.spacing.x = unit(0.1, "cm"),
        legend.title = element_blank(),
        text = element_text(size=10, family="Inter"),
        panel.grid = element_blank(),
        axis.line = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        legend.background = element_blank(),
        legend.key.height = unit(0.3, "cm")) +
  coord_cartesian(xlim=c(-1.4, 1.4), ylim=c(-1.2, 1.2))

ggsave(paste0(output_dir, "montage.png"), p, units="cm", width=7.5, height=7.5)

```

