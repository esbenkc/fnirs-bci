---
title: "Figures for the thesis 'Lights in the Brain'"
author: "Esben Kran"
date: "4th of January"
---

```{r}
pacman::p_load(tidyverse, R.matlab, showtext, viridis, purrr, ggrepel, png, grid, ggthemes, forcats)
font_add_google("Inter", "Inter")
output_dir = "../media/figures/"
```


## HbO and HbR absorption spectra
```{r}
p <- readMat("../data/extinction_coef.mat")[1]$extinct.coef %>% 
  as_tibble %>% 
  select("lambda" = V1, HbO = V2, HbR = V3) %>% 
  pivot_longer(cols=c("HbO", "HbR"), 
               names_to="Haemoglobin", 
               values_to="Extinction coefficient") %>%
  filter(lambda > 675 & lambda < 975) %>% 
  ggplot() +
  aes(x = lambda, y = `Extinction coefficient`, color = Haemoglobin) +
  geom_line() +
  coord_cartesian(expand=F) +
  theme_classic() +
  labs(x = "Î»") +
  geom_vline(xintercept=850, linetype="dashed",
             color=viridis(2, end=0.7)[1]) +
  geom_vline(xintercept=760, linetype="dashed",
             color=viridis(2, end=0.7)[2]) +
  annotate("text", x = 845, y = 2000, hjust=1,
           label="850 HbO", color=viridis(2, end=0.7)[1]) +
  annotate("text", x = 755, y = 2000, hjust=1, 
           label="760 HbR", color=viridis(2, end=0.7)[2]) +
  scale_color_viridis(end=0.7, discrete=T) +
  theme(legend.position = c(0.8,0.7),
        text = element_text(family="Inter"),
        panel.grid = element_blank(),
        legend.key.height = unit(0.45, "cm"))

ggsave(paste0(output_dir, "absorption-spectrum.png"), p, units="cm", width=10, height=7.5)
```

## Probe positions
```{r fig.width=5, fig.height=5}
mat <- readMat("../data/probe_positions.mat")[1]$probeInfo[[2]]

source_pos = mat[5] %>% 
  as.data.frame %>% 
  select(x=X1, y=X2) %>% 
  mutate(
    index=row_number(),
    type="Source"
  ) %>% 
  inner_join(
    mat[8] %>% 
      as_tibble(.name_repair="universal") %>% 
      map(unlist) %>% 
      as_tibble(.name_repair="universal") %>% 
      select(name=`...1`) %>%
      mutate(index=row_number())
  )

detector_pos = mat[10] %>% 
  as.data.frame %>% 
  select(x=X1, y=X2) %>% 
  mutate(
    index=row_number(),
    type="Detector"
  ) %>% 
  inner_join(
    mat[12] %>% 
      as_tibble(.name_repair="universal") %>% 
      map(unlist) %>% 
      as_tibble(.name_repair="universal") %>% 
      select(name=`...1`) %>%
      mutate(index=row_number())
  )


p <- rbind(detector_pos, source_pos) %>%
  ggplot() +
  aes(x, y, color = type, label = name) +
  annotation_custom(
    rasterGrob(readPNG("../media/10-20_bg.png"), interpolate=T),
    xmin = -1, xmax = 1, ymin=-1.1) +
  # geom_text_repel(size=2) +
  geom_point(size=1.5, alpha=0.9) +
  annotate("text", label="Circle indicates the\n'equator' of the head", x = 1.2, y = 0.7, hjust=0, vjust=1, lineheight=1) +
  theme_classic() +
  scale_color_viridis(end=0.7, discrete=T) +
  theme(legend.position = c(0.65,0.55),
        legend.spacing.x = unit(0.1, "cm"),
        legend.title = element_blank(),
        text = element_text(family="Inter"),
        panel.grid = element_blank(),
        axis.line = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        legend.background = element_blank(),
        legend.key.height = unit(0.5, "cm")) +
  coord_cartesian(xlim=c(-1, 3), ylim=c(-1.3, 1.3), clip="off")

ggsave(paste0(output_dir, "montage.png"), p, units="cm", width=9, height=7.5)

```

## Prediction example
```{r include=F}
df <- read_csv("../data/visualization/prediction_example.csv", progress=F)

p <- df %>% 
  pivot_longer(cols = matches("Prediction")) %>% 
  mutate(
    pred_type = if_else(str_detect(name, "self"), "Self prediction", "Real prediction"),
    future = as.numeric(str_extract(name, "(?<=\\d_)\\d+")),
    past = 39,
    facet = str_extract(name, "(?<=.{1,20})\\d") %>% str_remove("_self"),
    facet = case_when(
      facet == 0 ~ "16-sample trained LSTM",
      facet == 1 ~ " 16-sample trained triple-stacked LSTM ",
      facet == 2 ~ " 4-sample trained LSTM ",
      facet == 3 ~ "Last-value baseline",
      facet == 4 ~ "Gaussian random",
      facet == 5 ~ "Delayed 39-sample moving average",
      T ~ facet
    )
  ) %>% 
  ggplot() +
  aes(Index, value, color=pred_type, group=rev(pred_type)) +
  geom_line(aes(y = Real), color=viridis(1), alpha=0.3) +
  geom_line(alpha=1) +
  geom_hline(yintercept = 0, alpha=0.2) +
  facet_wrap(~facet, ncol=2) +
  geom_vline(aes(xintercept=past + future), linetype="dashed") +
  geom_text(aes(x = past + future + 4, label = paste0("Prediction\nstart: ", future)), color="black", hjust=0, y = 1.8, lineheight=0.9, size=3) +
  geom_vline(aes(xintercept=past)) +
  annotate("text", label="Past", x=35, hjust=1, y = 1.8, lineheight=0.9, size=3) +
  coord_cartesian(expand=F, ylim=c(-2.5, 2.9), xlim=c(0,200)) +
  scale_color_viridis_d(end = 0.7, limits=c("True value", "Self prediction", "Real prediction")) +
  theme_bw() +
  # guides(color=guide_legend(ncol=2)) +
  theme(
    panel.grid = element_blank(),
    legend.position = "top",
    text = element_text(family="Lato", lineheight = 0.5),
    panel.margin = unit(0, "cm")
  ) +
  labs(color=NULL, x="Sample", y="HbO")

ggsave(paste0(output_dir, "prediction_example.png"), p, units="px", width=2056, height=1500)

```

## Vis of fNIRS data
```{r}
df <- read_csv("../data/visualization/prediction_example.csv", progress=F)

p <- df %>% 
  ggplot() +
  aes(x = Index, y = Real) +
  geom_line(color="#707070", size=0.1) +
  coord_cartesian(expand=F) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.line = element_blank(),
    axis.text = element_blank(),
    panel.spacing = unit(0, "cm"),
  )

ggsave(paste0(output_dir, "sample_data.png"), p, units="px", width=1123, height=150)
  
```





